<!-- SAME HEAD / STYLE AS BEFORE -->
<!-- Only showing script portion change for clarity -->

<script>

const LS_HOLDINGS="lean_holdings_csv_url";
const LS_SYSTEM="lean_system_csv_url";

const valRegime=document.getElementById("valRegime");
const valDeploy=document.getElementById("valDeploy");
const valCash=document.getElementById("valCash");
const valL5=document.getElementById("valL5");
const valLiq=document.getElementById("valLiq");
const valVol=document.getElementById("valVol");
const valViol=document.getElementById("valViol");

const violationsText=document.getElementById("violationsText");
const checklistText=document.getElementById("checklistText");
const divergenceBanner=document.getElementById("divergenceBanner");

const leanSignal=document.getElementById("leanSignal");

function streetLine(text){
  return "<div style='color:#ef4444;margin-top:6px;font-weight:800;'>ðŸ”´ STREET: "+text+"</div>";
}

function computeStreetSpeak(){
  let street = "";

  if(valRegime.textContent.includes("RISK ON") &&
     valVol.textContent.includes("WATCH")){
     street += streetLine("You can nibble, donâ€™t get cute.");
  }

  if(valRegime.textContent.includes("RISK ON") &&
     parseFloat(valCash.textContent)/100 > 0.5){
     street += streetLine("Marketâ€™s running. Youâ€™re parked.");
  }

  if(valViol.textContent === "â€”" || valViol.textContent === ""){
     street += streetLine("Youâ€™re not doing anything stupid.");
  } else {
     street += streetLine("Youâ€™re bending your own rules.");
  }

  leanSignal.innerHTML += street;
}

async function loadSystem(){
  if(!systemUrl.value) return;

  const rows=parseCSV(await fetchText(systemUrl.value));
  const map=new Map();
  rows.forEach(r=>map.set((r[0]||"").toUpperCase(),(r[1]||"").trim()));

  valRegime.textContent=map.get("MARKET REGIME")||"â€”";
  valDeploy.textContent=map.get("DEPLOYMENT SIGNAL")||"â€”";
  valCash.textContent=map.get("CASH ANCHOR %")||"â€”";
  valL5.textContent=map.get("LEVEL5 TOTAL %")||"â€”";
  valLiq.textContent=map.get("LIQUIDITY")||"â€”";
  valVol.textContent=map.get("VOLATILITY")||"â€”";
  valViol.textContent=map.get("RULE VIOLATIONS")||"â€”";

  checklistText.textContent=map.get("TODAY'S CHECKLIST")||"â€”";

  violationsText.textContent =
    valViol.textContent && valViol.textContent !== "â€”"
      ? valViol.textContent
      : "âœ… No violations";

  divergenceBanner.textContent="";
  if(valRegime.textContent.includes("RISK ON") &&
     valCash.textContent.includes("%") &&
     parseFloat(valCash.textContent)/100>0.5){
      divergenceBanner.innerHTML =
        "âš  Posture Divergence: Heavy cash in Risk-On regime."
        + streetLine("Marketâ€™s running. Youâ€™re parked.");
  }

  leanSignal.innerHTML = "LEAN SIGNAL: " + valDeploy.textContent;
  computeStreetSpeak();

  updateTimestamp();
}
</script>
