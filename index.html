<script>
  // --- Local storage keys
  const LS_HOLDINGS = "lean_holdings_csv_url";
  const LS_SYSTEM   = "lean_system_csv_url";
  const LS_NOTES    = "lean_notes";
  const LS_L5_TOGGLE = "lean_level5_toggle"; // optional manual toggle for module display

  // --- Elements
  const statusLine  = document.getElementById("statusLine");
  const holdingsUrl = document.getElementById("holdingsUrl");
  const systemUrl   = document.getElementById("systemUrl");
  const notesBox    = document.getElementById("notesBox");
  const noteInline  = document.getElementById("noteInline");

  const valRegime = document.getElementById("valRegime");
  const valDeploy = document.getElementById("valDeploy");
  const valCash   = document.getElementById("valCash");
  const valL5     = document.getElementById("valL5");

  const dotRegime = document.getElementById("dotRegime");
  const dotDeploy = document.getElementById("dotDeploy");
  const dotCash   = document.getElementById("dotCash");
  const dotL5     = document.getElementById("dotL5");

  const totalValueEl = document.getElementById("totalValue");
  const holdingsBody = document.getElementById("holdingsBody");

  // Optional banner (created dynamically so you don't have to edit HTML again)
  let divergenceBanner = document.getElementById("divergenceBanner");
  if (!divergenceBanner) {
    divergenceBanner = document.createElement("div");
    divergenceBanner.id = "divergenceBanner";
    divergenceBanner.style.marginTop = "12px";
    divergenceBanner.style.fontSize = "12px";
    divergenceBanner.style.fontWeight = "700";
    divergenceBanner.style.color = "#f59e0b";
    // Insert it under the "App 1.0 reads two published CSVs..." line
    const gmSmall = document.querySelector(".card .small");
    if (gmSmall && gmSmall.parentElement) gmSmall.parentElement.appendChild(divergenceBanner);
  }

  // --- Small helpers
  const money = (n) => {
    if (!isFinite(n)) return "$â€”";
    return n.toLocaleString(undefined, { style:"currency", currency:"USD" });
  };

  function setDot(dotEl, state){
    dotEl.classList.remove("green","yellow","red");
    dotEl.classList.add(state); // "green" | "yellow" | "red"
  }

  // Timestamp updater (big, subtle flash)
  function updateTimestamp(){
    const el = document.getElementById("lastUpdated");
    if (!el) return;
    const now = new Date();
    el.textContent = "LAST UPDATED: " + now.toLocaleTimeString();

    // subtle flash
    el.style.opacity = "0.35";
    setTimeout(() => { el.style.opacity = "1"; }, 200);
  }

  // Lightweight CSV parser that handles quoted fields
  function parseCSV(text){
    const rows = [];
    let row = [], field = "", inQuotes = false;
    for (let i=0;i<text.length;i++){
      const c = text[i];
      const next = text[i+1];
      if (c === '"' && inQuotes && next === '"'){ field += '"'; i++; continue; }
      if (c === '"'){ inQuotes = !inQuotes; continue; }
      if (c === ',' && !inQuotes){ row.push(field); field=""; continue; }
      if ((c === '\n' || c === '\r') && !inQuotes){
        if (c === '\r' && next === '\n') i++;
        row.push(field);
        if (row.some(v => v.trim() !== "")) rows.push(row);
        row = []; field="";
        continue;
      }
      field += c;
    }
    row.push(field);
    if (row.some(v => v.trim() !== "")) rows.push(row);
    return rows;
  }

  function normalizeHeader(h){ return (h||"").trim().toLowerCase(); }

  async function fetchText(url){
    // cache-bust to avoid stale CSV
    const sep = url.includes("?") ? "&" : "?";
    const res = await fetch(url + sep + "t=" + Date.now(), { cache:"no-store" });
    if (!res.ok) throw new Error("Fetch failed: " + res.status);
    return await res.text();
  }

  // --- SYSTEM_EXPORT reader
  async function loadSystem(){
    const url = systemUrl.value.trim();

    // Reset defaults if missing URL
    if (!url){
      valRegime.textContent = "â€”";
      valDeploy.textContent = "â€”";
      valCash.textContent = "â€”";
      valL5.textContent = "â€”";
      setDot(dotRegime, "yellow");
      setDot(dotDeploy, "yellow");
      setDot(dotCash, "yellow");
      setDot(dotL5, "yellow");
      divergenceBanner.textContent = "";
      document.body.classList.remove("risk-on","defensive","transition");
      updateTimestamp();
      return;
    }

    const text = await fetchText(url);
    const rows = parseCSV(text);

    // Expect 2 columns: label,value
    const map = new Map();
    for (const r of rows){
      const label = (r[0]||"").trim();
      const value = (r[1]||"").trim();
      if (label) map.set(label.toUpperCase(), value);
    }

    const regime = map.get("MARKET REGIME") || "â€”";
    const deploy = map.get("DEPLOYMENT SIGNAL") || "â€”";
    const cash   = map.get("CASH ANCHOR %") || "â€”";
    const l5     = map.get("LEVEL5 TOTAL %") || map.get("LEVEL5 TOTAL%") || "â€”";

    valRegime.textContent = regime;
    valDeploy.textContent = deploy;
    valCash.textContent = cash;
    valL5.textContent = l5;

    // Dots: infer from emoji / keywords
    const dotFromText = (t) => {
      const s = (t||"").toLowerCase();
      if (s.includes("ðŸŸ¢") || s.includes("risk on") || s.includes("aligned") || s.includes("ok")) return "green";
      if (s.includes("ðŸ”´") || s.includes("defensive") || s.includes("over")) return "red";
      if (s.includes("ðŸŸ¡") || s.includes("consider") || s.includes("transition") || s.includes("watch")) return "yellow";
      return "yellow";
    };

    setDot(dotRegime, dotFromText(regime));
    setDot(dotDeploy, dotFromText(deploy));

    // Cash dot: >50% green defensive; 25â€“50 yellow; else red
    if (typeof cash === "string" && cash.includes("%")){
      const num = parseFloat(cash.replace("%","")) / 100;
      if (isFinite(num)){
        setDot(dotCash, num > 0.50 ? "green" : (num > 0.25 ? "yellow" : "red"));
      } else setDot(dotCash, dotFromText(cash));
    } else {
      setDot(dotCash, dotFromText(cash));
    }

    // Level5 dot: <=3% green, <=5% yellow, else red
    if (typeof l5 === "string" && l5.includes("%")){
      const num = parseFloat(l5.replace("%","")) / 100;
      if (isFinite(num)){
        setDot(dotL5, num <= 0.03 ? "green" : (num <= 0.05 ? "yellow" : "red"));
      } else setDot(dotL5, dotFromText(l5));
    } else {
      setDot(dotL5, dotFromText(l5));
    }

    // Regime glow (FIXED: this now runs)
    document.body.classList.remove("risk-on","defensive","transition");
    const regimeText = (regime || "").toLowerCase();
    if (regimeText.includes("risk on")) {
      document.body.classList.add("risk-on");
    } else if (regimeText.includes("defensive")) {
      document.body.classList.add("defensive");
    } else {
      document.body.classList.add("transition");
    }

    // Divergence banner (simple + useful)
    // Show when RISK ON but cash is high (e.g., > 50%)
    divergenceBanner.textContent = "";
    if (cash.includes("%")){
      const cashNum = parseFloat(cash.replace("%","")) / 100;
      if (regimeText.includes("risk on") && isFinite(cashNum) && cashNum > 0.50) {
        divergenceBanner.textContent = "âš  Posture Divergence: Heavy cash in Risk-On regime.";
      }
    }

    updateTimestamp();
  }

  // --- HOLDINGS reader
  async function loadHoldings(){
    const url = holdingsUrl.value.trim();
    if (!url){
      holdingsBody.innerHTML = `<tr><td class="muted" colspan="7">Paste your HOLDINGS CSV URL, click Save, then Refresh.</td></tr>`;
      totalValueEl.textContent = "$â€”";
      updateTimestamp();
      return;
    }

    const text = await fetchText(url);
    const rows = parseCSV(text);
    if (!rows.length){
      holdingsBody.innerHTML = `<tr><td class="muted" colspan="7">No rows found in CSV.</td></tr>`;
      updateTimestamp();
      return;
    }

    const headers = rows[0].map(normalizeHeader);
    const idx = (name) => headers.indexOf(name);

    // Map common header names
    const iTicker = idx("ticker");
    const iRole   = idx("role");
    const iBucket = idx("bucket");
    const iShares = idx("shares");
    const iPrice  = idx("price");
    const iValue  = idx("value");
    const iNotes  = idx("notes");

    let total = 0;
    const bodyRows = [];

    for (let r=1; r<rows.length; r++){
      const row = rows[r];
      const ticker = (row[iTicker] ?? "").trim();
      if (!ticker) continue;

      const role   = (row[iRole] ?? "").trim();
      const bucket = (row[iBucket] ?? "").trim();
      const shares = parseFloat((row[iShares] ?? "").toString().replace(/[^0-9.\-]/g,"")) || 0;
      const price  = parseFloat((row[iPrice]  ?? "").toString().replace(/[^0-9.\-]/g,"")) || 0;
      const value  = parseFloat((row[iValue]  ?? "").toString().replace(/[^0-9.\-]/g,"")) || (shares * price);
      const notes  = (row[iNotes] ?? "").trim();

      total += (isFinite(value) ? value : 0);

      bodyRows.push(`
        <tr>
          <td><b>${ticker}</b></td>
          <td>${role || `<span class="muted">â€”</span>`}</td>
          <td>${bucket || `<span class="muted">â€”</span>`}</td>
          <td class="right">${shares ? shares.toFixed(4) : `<span class="muted">â€”</span>`}</td>
          <td class="right">${price ? money(price) : `<span class="muted">â€”</span>`}</td>
          <td class="right">${value ? money(value) : `<span class="muted">â€”</span>`}</td>
          <td>${notes || `<span class="muted">â€”</span>`}</td>
        </tr>
      `);
    }

    holdingsBody.innerHTML = bodyRows.length
      ? bodyRows.join("")
      : `<tr><td class="muted" colspan="7">No holdings found (check your CSV headers and rows).</td></tr>`;

    totalValueEl.textContent = money(total);
    updateTimestamp();
  }

  function loadLocal(){
    holdingsUrl.value = localStorage.getItem(LS_HOLDINGS) || "";
    systemUrl.value   = localStorage.getItem(LS_SYSTEM) || "";
    notesBox.value    = localStorage.getItem(LS_NOTES) || "";
    noteInline.textContent = notesBox.value ? notesBox.value : "â€”";
  }

  function saveLocal(){
    localStorage.setItem(LS_HOLDINGS, holdingsUrl.value.trim());
    localStorage.setItem(LS_SYSTEM, systemUrl.value.trim());
    localStorage.setItem(LS_NOTES, notesBox.value.trim());
    noteInline.textContent = notesBox.value.trim() ? notesBox.value.trim() : "â€”";
  }

  // Buttons
  document.getElementById("saveBtn").addEventListener("click", async () => {
    saveLocal();
    statusLine.textContent = "Saved. Refreshingâ€¦";
    try{
      await Promise.all([loadSystem(), loadHoldings()]);
      statusLine.textContent = "Saved + refreshed.";
    }catch(e){
      statusLine.textContent = "Saved, but refresh failed (check CSV links).";
      console.error(e);
    }
  });

  document.getElementById("refreshBtn").addEventListener("click", async () => {
    statusLine.textContent = "Refreshingâ€¦";
    try{
      await Promise.all([loadSystem(), loadHoldings()]);
      statusLine.textContent = "Refresh complete.";
    }catch(e){
      statusLine.textContent = "Refresh failed (check CSV links).";
      console.error(e);
    }
  });

  document.getElementById("runScanBtn").addEventListener("click", async () => {
    statusLine.textContent = "Running scanâ€¦";
    try{
      await loadSystem();
      statusLine.textContent = "Good Morning scan complete.";
    }catch(e){
      statusLine.textContent = "Scan failed (check SYSTEM_EXPORT CSV link).";
      console.error(e);
    }
  });

  document.getElementById("toggleL5Btn").addEventListener("click", () => {
    const current = localStorage.getItem(LS_L5_TOGGLE) || "OFF";
    const next = current === "ON" ? "OFF" : "ON";
    localStorage.setItem(LS_L5_TOGGLE, next);
    alert("Level 5 module toggle: " + next + " (manual UI toggle only)");
  });

  // Initial load
  (async function init(){
    loadLocal();
    try{
      await Promise.all([loadSystem(), loadHoldings()]);
      statusLine.textContent = "Loaded from saved links.";
    }catch(e){
      statusLine.textContent = "Paste CSV links and click Save.";
      console.error(e);
    }
  })();

  // Auto refresh every 60 seconds
  setInterval(async () => {
    try {
      await Promise.all([loadSystem(), loadHoldings()]);
      statusLine.textContent = "Auto-refresh complete.";
    } catch (e) {
      console.error("Auto-refresh failed:", e);
    }
  }, 60000);

  // Service worker (optional)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
</script>
