<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lean Terminal ‚Äî App 1.0</title>
  <meta name="theme-color" content="#0b0b0d" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      --bg:#0b0b0d; --panel:#121217; --panel2:#0f0f13;
      --text:#f3f4f6; --muted:#a7aab3; --line:#222331;
      --green:#22c55e; --yellow:#f59e0b; --red:#ef4444; --blue:#60a5fa;
      --pill:#0e0e13;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 800px at 30% 0%, #12121a 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{
      padding:28px 24px 10px 24px;
      border-bottom:1px solid rgba(255,255,255,.04);
    }
    h1{margin:0; font-size:22px; font-weight:700}
    .sub{margin-top:6px; color:var(--muted); font-size:13px}
    .wrap{max-width:1120px; margin:0 auto; padding:18px 18px 40px;}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .card h2{margin:0; font-size:18px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.green{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.30)}
    .btn.gold{background:rgba(245,158,11,.18); border-color:rgba(245,158,11,.30)}
    .btn:active{transform:translateY(1px)}
    .pills{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .pill{
      display:flex; align-items:center; gap:10px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.06);
      padding:10px 12px;
      border-radius: 999px;
      font-size:13px;
      color:var(--text);
    }
    .dot{width:10px; height:10px; border-radius:999px; background:var(--yellow)}
    .dot.green{background:var(--green)}
    .dot.red{background:var(--red)}
    .dot.yellow{background:var(--yellow)}
    .kv{display:flex; flex-direction:column; gap:4px}
    .kv b{font-size:12px; color:var(--muted); font-weight:600; letter-spacing:.2px}
    .kv span{font-size:13px; font-weight:700}
    .small{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.35}
    .inputs{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px}
    @media (max-width: 720px){ .inputs{grid-template-columns:1fr} }
    input, textarea{
      width:100%;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      outline:none;
    }
    textarea{min-height:44px; resize:vertical}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06); font-size:13px}
    th{color:var(--muted); font-weight:700; text-align:left}
    .muted{color:var(--muted)}
    .right{ text-align:right }
    .footer-note{margin-top:6px; color:var(--muted); font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>Lean Terminal ‚Äî App 1.0</h1>
    <div class="sub" id="statusLine">Good Morning scan: ready.</div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- Good Morning -->
    <section class="card">
      <div class="row">
        <h2>Good Morning</h2>
        <button class="btn green" id="runScanBtn">Run Scan</button>
      </div>

      <div class="pills" style="margin-top:14px">
        <div class="pill">
          <div class="dot" id="dotRegime"></div>
          <div class="kv">
            <b>Regime</b>
            <span id="valRegime">‚Äî</span>
          </div>
        </div>
        <div class="pill">
          <div class="dot" id="dotDeploy"></div>
          <div class="kv">
            <b>Deployment</b>
            <span id="valDeploy">‚Äî</span>
          </div>
        </div>
        <div class="pill">
          <div class="dot" id="dotCash"></div>
          <div class="kv">
            <b>Cash Anchor</b>
            <span id="valCash">‚Äî</span>
          </div>
        </div>
        <div class="pill">
          <div class="dot" id="dotL5"></div>
          <div class="kv">
            <b>Level 5</b>
            <span id="valL5">‚Äî</span>
          </div>
        </div>
      </div>

      <div class="small">
        App 1.0 reads two published CSVs: <span class="mono">HOLDINGS</span> (table) and <span class="mono">SYSTEM_EXPORT</span> (status).
      </div>
    </section>

    <!-- Data Source -->
    <section class="card">
      <div class="row">
        <h2>Data Source</h2>
        <button class="btn" id="saveBtn">Save</button>
      </div>

      <div class="inputs">
        <div>
          <div class="footer-note">Holdings CSV URL (Google Sheets ‚Üí Publish as CSV)</div>
          <input id="holdingsUrl" placeholder="Paste HOLDINGS CSV URL here (output=csv)" />
        </div>
        <div>
          <div class="footer-note">System CSV URL (SYSTEM_EXPORT tab ‚Üí Publish as CSV)</div>
          <input id="systemUrl" placeholder="Paste SYSTEM_EXPORT CSV URL here (output=csv)" />
        </div>
        <div style="grid-column:1/-1">
          <div class="footer-note">Notes (stored locally on device)</div>
          <textarea id="notesBox" placeholder='e.g., "Watching volatility compression"'></textarea>
        </div>
      </div>

      <div class="small">
        Tip: These are stored locally in your browser. If you clear website data, you‚Äôll need to paste again.
      </div>
    </section>
  </div>

  <!-- Holdings -->
  <section class="card" style="margin-top:18px">
    <div class="row">
      <h2>Holdings</h2>
      <button class="btn" id="refreshBtn">Refresh</button>
    </div>
    <div class="sub" style="padding:6px 0 0 0">
      Approx total value: <b id="totalValue">$‚Äî</b>
      <span class="muted"> ‚Ä¢ Note:</span> <span id="noteInline" class="muted">‚Äî</span>
    </div>

    <table>
      <thead>
        <tr>
          <th>Ticker</th>
          <th>Role</th>
          <th>Bucket</th>
          <th class="right">Shares</th>
          <th class="right">Price</th>
          <th class="right">Value</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody id="holdingsBody">
        <tr><td class="muted" colspan="7">Waiting for data‚Ä¶</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Level 5 Module -->
  <section class="card" style="margin-top:18px">
    <div class="row">
      <h2>Level 5 Module</h2>
      <button class="btn gold" id="toggleL5Btn">Toggle Module</button>
    </div>
    <div class="small" style="margin-top:10px">
      This block can be removed later without affecting Lean. App 1.0 shows ‚ÄúON/OFF‚Äù based on your scan rules.
      <ul>
        <li>Rules: -15% hard stop, no averaging, profits ‚Üí SGOV</li>
        <li>Activation (example): VIX cooling + RS leaders + compression breakout</li>
      </ul>
    </div>
  </section>
</div>

<script>
  // --- Local storage keys
  const LS_HOLDINGS = "lean_holdings_csv_url";
  const LS_SYSTEM   = "lean_system_csv_url";
  const LS_NOTES    = "lean_notes";
  const LS_L5_TOGGLE = "lean_level5_toggle"; // optional manual toggle for module display

  // --- Elements
  const statusLine  = document.getElementById("statusLine");
  const holdingsUrl = document.getElementById("holdingsUrl");
  const systemUrl   = document.getElementById("systemUrl");
  const notesBox    = document.getElementById("notesBox");
  const noteInline  = document.getElementById("noteInline");

  const valRegime = document.getElementById("valRegime");
  const valDeploy = document.getElementById("valDeploy");
  const valCash   = document.getElementById("valCash");
  const valL5     = document.getElementById("valL5");

  const dotRegime = document.getElementById("dotRegime");
  const dotDeploy = document.getElementById("dotDeploy");
  const dotCash   = document.getElementById("dotCash");
  const dotL5     = document.getElementById("dotL5");

  const totalValueEl = document.getElementById("totalValue");
  const holdingsBody = document.getElementById("holdingsBody");

  // --- Small helpers
  const money = (n) => {
    if (!isFinite(n)) return "$‚Äî";
    return n.toLocaleString(undefined, { style:"currency", currency:"USD" });
  };
  const pct = (n) => {
    if (!isFinite(n)) return "‚Äî";
    return (n*100).toFixed(2) + "%";
  };

  function setDot(dotEl, state){
    dotEl.classList.remove("green","yellow","red");
    dotEl.classList.add(state); // "green" | "yellow" | "red"
  }

  // Lightweight CSV parser that handles quoted fields
  function parseCSV(text){
    const rows = [];
    let row = [], field = "", inQuotes = false;
    for (let i=0;i<text.length;i++){
      const c = text[i];
      const next = text[i+1];
      if (c === '"' && inQuotes && next === '"'){ field += '"'; i++; continue; }
      if (c === '"'){ inQuotes = !inQuotes; continue; }
      if (c === ',' && !inQuotes){ row.push(field); field=""; continue; }
      if ((c === '\n' || c === '\r') && !inQuotes){
        if (c === '\r' && next === '\n') i++;
        row.push(field);
        if (row.some(v => v.trim() !== "")) rows.push(row);
        row = []; field="";
        continue;
      }
      field += c;
    }
    row.push(field);
    if (row.some(v => v.trim() !== "")) rows.push(row);
    return rows;
  }

  function normalizeHeader(h){ return (h||"").trim().toLowerCase(); }

  async function fetchText(url){
    // cache-bust to avoid stale CSV
    const sep = url.includes("?") ? "&" : "?";
    const res = await fetch(url + sep + "t=" + Date.now(), { cache:"no-store" });
    if (!res.ok) throw new Error("Fetch failed: " + res.status);
    return await res.text();
  }

  // --- SYSTEM_EXPORT reader
  async function loadSystem(){
    const url = systemUrl.value.trim();
    if (!url){
      valRegime.textContent = "‚Äî";
      valDeploy.textContent = "‚Äî";
      valCash.textContent = "‚Äî";
      valL5.textContent = "‚Äî";
      setDot(dotRegime, "yellow");
      setDot(dotDeploy, "yellow");
      setDot(dotCash, "yellow");
      setDot(dotL5, "yellow");
      return;
    }

    const text = await fetchText(url);
    const rows = parseCSV(text);
    // Expect 2 columns: label,value
    const map = new Map();
    for (const r of rows){
      const label = (r[0]||"").trim();
      const value = (r[1]||"").trim();
      if (label) map.set(label.toUpperCase(), value);
    }

    const regime = map.get("MARKET REGIME") || "‚Äî";
    const deploy = map.get("DEPLOYMENT SIGNAL") || "‚Äî";
    const cash   = map.get("CASH ANCHOR %") || "‚Äî";
    const l5     = map.get("LEVEL5 TOTAL %") || map.get("LEVEL5 TOTAL%") || "‚Äî";

    valRegime.textContent = regime;
    valDeploy.textContent = deploy;
    valCash.textContent = cash;
    valL5.textContent = l5;

    // Dots: infer from emoji / keywords
    const dotFromText = (t) => {
      const s = (t||"").toLowerCase();
      if (s.includes("üü¢") || s.includes("risk on") || s.includes("aligned") || s.includes("ok")) return "green";
      if (s.includes("üî¥") || s.includes("defensive") || s.includes("over")) return "red";
      if (s.includes("üü°") || s.includes("consider") || s.includes("transition") || s.includes("watch")) return "yellow";
      return "yellow";
    };

    setDot(dotRegime, dotFromText(regime));
    setDot(dotDeploy, dotFromText(deploy));
    // Cash dot: >50% green defensive; 25‚Äì50 yellow; else red (fallback if no emoji)
    if (typeof cash === "string" && cash.includes("%")){
      const num = parseFloat(cash.replace("%","")) / 100;
      if (isFinite(num)){
        setDot(dotCash, num > 0.50 ? "green" : (num > 0.25 ? "yellow" : "red"));
      } else setDot(dotCash, dotFromText(cash));
    } else setDot(dotCash, dotFromText(cash));
    // Level5 dot: if tiny or "0" = green (controlled), else yellow
    if (typeof l5 === "string" && l5.includes("%")){
      const num = parseFloat(l5.replace("%","")) / 100;
      if (isFinite(num)){
        setDot(dotL5, num <= 0.03 ? "green" : (num <= 0.05 ? "yellow" : "red"));
      } else setDot(dotL5, dotFromText(l5));
    } else setDot(dotL5, dotFromText(l5));
  }

  // --- HOLDINGS reader
  async function loadHoldings(){
    const url = holdingsUrl.value.trim();
    if (!url){
      holdingsBody.innerHTML = `<tr><td class="muted" colspan="7">Paste your HOLDINGS CSV URL, click Save, then Refresh.</td></tr>`;
      totalValueEl.textContent = "$‚Äî";
      return;
    }

    const text = await fetchText(url);
    const rows = parseCSV(text);
    if (!rows.length){
      holdingsBody.innerHTML = `<tr><td class="muted" colspan="7">No rows found in CSV.</td></tr>`;
      return;
    }

    const headers = rows[0].map(normalizeHeader);
    const idx = (name) => headers.indexOf(name);

    // Map common header names
    const iTicker = idx("ticker");
    const iRole   = idx("role");
    const iBucket = idx("bucket");
    const iShares = idx("shares");
    const iPrice  = idx("price");
    const iValue  = idx("value");
    const iNotes  = idx("notes");

    let total = 0;
    const bodyRows = [];

    for (let r=1; r<rows.length; r++){
      const row = rows[r];
      const ticker = (row[iTicker] ?? "").trim();
      if (!ticker) continue;

      const role   = (row[iRole] ?? "").trim();
      const bucket = (row[iBucket] ?? "").trim();
      const shares = parseFloat((row[iShares] ?? "").toString().replace(/[^0-9.\-]/g,"")) || 0;
      const price  = parseFloat((row[iPrice]  ?? "").toString().replace(/[^0-9.\-]/g,"")) || 0;
      const value  = parseFloat((row[iValue]  ?? "").toString().replace(/[^0-9.\-]/g,"")) || (shares * price);
      const notes  = (row[iNotes] ?? "").trim();

      total += (isFinite(value) ? value : 0);

      bodyRows.push(`
        <tr>
          <td><b>${ticker}</b></td>
          <td>${role || `<span class="muted">‚Äî</span>`}</td>
          <td>${bucket || `<span class="muted">‚Äî</span>`}</td>
          <td class="right">${shares ? shares.toFixed(4) : `<span class="muted">‚Äî</span>`}</td>
          <td class="right">${price ? money(price) : `<span class="muted">‚Äî</span>`}</td>
          <td class="right">${value ? money(value) : `<span class="muted">‚Äî</span>`}</td>
          <td>${notes || `<span class="muted">‚Äî</span>`}</td>
        </tr>
      `);
    }

    holdingsBody.innerHTML = bodyRows.length
      ? bodyRows.join("")
      : `<tr><td class="muted" colspan="7">No holdings found (check your CSV headers and rows).</td></tr>`;

    totalValueEl.textContent = money(total);
  }

  function loadLocal(){
    holdingsUrl.value = localStorage.getItem(LS_HOLDINGS) || "";
    systemUrl.value   = localStorage.getItem(LS_SYSTEM) || "";
    notesBox.value    = localStorage.getItem(LS_NOTES) || "";
    noteInline.textContent = notesBox.value ? notesBox.value : "‚Äî";
  }

  function saveLocal(){
    localStorage.setItem(LS_HOLDINGS, holdingsUrl.value.trim());
    localStorage.setItem(LS_SYSTEM, systemUrl.value.trim());
    localStorage.setItem(LS_NOTES, notesBox.value.trim());
    noteInline.textContent = notesBox.value.trim() ? notesBox.value.trim() : "‚Äî";
  }

  // Buttons
  document.getElementById("saveBtn").addEventListener("click", async () => {
    saveLocal();
    statusLine.textContent = "Saved. Refreshing‚Ä¶";
    try{
      await Promise.all([loadSystem(), loadHoldings()]);
      statusLine.textContent = "Saved + refreshed.";
    }catch(e){
      statusLine.textContent = "Saved, but refresh failed (check CSV links).";
      console.error(e);
    }
  });

  document.getElementById("refreshBtn").addEventListener("click", async () => {
    statusLine.textContent = "Refreshing‚Ä¶";
    try{
      await Promise.all([loadSystem(), loadHoldings()]);
      statusLine.textContent = "Refresh complete.";
    }catch(e){
      statusLine.textContent = "Refresh failed (check CSV links).";
      console.error(e);
    }
  });

  document.getElementById("runScanBtn").addEventListener("click", async () => {
    statusLine.textContent = "Running scan‚Ä¶";
    try{
      await loadSystem();
      statusLine.textContent = "Good Morning scan complete.";
    }catch(e){
      statusLine.textContent = "Scan failed (check SYSTEM_EXPORT CSV link).";
      console.error(e);
    }
  });

  document.getElementById("toggleL5Btn").addEventListener("click", () => {
    const current = localStorage.getItem(LS_L5_TOGGLE) || "OFF";
    const next = current === "ON" ? "OFF" : "ON";
    localStorage.setItem(LS_L5_TOGGLE, next);
    alert("Level 5 module toggle: " + next + " (manual UI toggle only)");
  });

  // Initial load
  (async function init(){
    loadLocal();
    try{
      await Promise.all([loadSystem(), loadHoldings()]);
      statusLine.textContent = "Loaded from saved links.";
    }catch(e){
      statusLine.textContent = "Paste CSV links and click Save.";
      console.error(e);
    }
  })();

  // Service worker (optional)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
</script>
</body>
</html>
