<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lean Terminal â€” App 1.0</title>

<style>
:root{
  --bg:#0b0b0d;
  --text:#f3f4f6;
  --muted:#a7aab3;
  --green:#22c55e;
  --yellow:#f59e0b;
  --red:#ef4444;
  --blue:#60a5fa;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:#0b0b0d;
  color:var(--text);
}
body.risk-on { box-shadow: inset 0 0 140px rgba(34,197,94,0.15); }
body.defensive { box-shadow: inset 0 0 140px rgba(239,68,68,0.15); }
body.transition { box-shadow: inset 0 0 140px rgba(245,158,11,0.15); }

header{
  padding:24px;
  border-bottom:1px solid rgba(255,255,255,.05);
}
.wrap{max-width:1100px;margin:auto;padding:24px}
h1{margin:0;font-size:22px}
.sub{color:var(--muted);font-size:13px;margin-top:6px}
#lastUpdated{
  margin-top:8px;
  font-size:18px;
  font-weight:800;
  color:var(--blue);
}
#nextRefresh{
  margin-top:4px;
  font-size:12px;
  color:var(--muted);
}

.card{
  margin-top:20px;
  padding:18px;
  border:1px solid rgba(255,255,255,.08);
  border-radius:12px;
  background:rgba(255,255,255,.02);
}
.pills{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:12px;
}
.pill{
  padding:10px 14px;
  border-radius:999px;
  background:rgba(0,0,0,.3);
  border:1px solid rgba(255,255,255,.08);
  font-size:13px;
}

button{
  padding:8px 14px;
  border-radius:8px;
  background:#1f2937;
  border:1px solid rgba(255,255,255,.15);
  color:white;
  cursor:pointer;
}
input, textarea{
  width:100%;
  margin-top:6px;
  padding:8px;
  background:#111;
  border:1px solid rgba(255,255,255,.15);
  color:white;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px;
}
th, td{
  padding:8px;
  border-bottom:1px solid rgba(255,255,255,.08);
  font-size:13px;
}
th{color:var(--muted);text-align:left}
.right{text-align:right}

#divergenceBanner{
  margin-top:10px;
  color:var(--yellow);
  font-weight:800;
}

#leanSignal{
  margin-top:12px;
  font-size:14px;
  font-weight:900;
  letter-spacing:.2px;
}
#leanSignal small{
  display:block;
  margin-top:6px;
  font-size:12px;
  font-weight:700;
  color:var(--muted);
}

#violations{
  margin-top:10px;
  font-size:13px;
  font-weight:900;
  letter-spacing:.2px;
}
#checklist{
  margin-top:10px;
  font-size:13px;
  font-weight:900;
  letter-spacing:.2px;
}

/* Always-on street speak */
.street{
  margin-top:6px;
  color:var(--red);
  font-weight:900;
  font-size:12px;
  letter-spacing:.2px;
}
</style>
</head>

<body>

<header>
  <div class="wrap">
    <h1>Lean Terminal â€” App 1.0</h1>
    <div class="sub" id="statusLine">Ready.</div>
    <div id="lastUpdated">LAST UPDATED: â€”</div>
    <div id="nextRefresh">Next refresh in: 60s</div>
  </div>
</header>

<div class="wrap">

  <div class="card">
    <h2>Good Morning</h2>
    <button id="runScanBtn">Run Scan</button>

    <div class="pills">
      <div class="pill">Regime: <span id="valRegime">â€”</span></div>
      <div class="pill">Deployment: <span id="valDeploy">â€”</span></div>
      <div class="pill">Cash: <span id="valCash">â€”</span></div>
      <div class="pill">Level 5: <span id="valL5">â€”</span></div>
      <div class="pill">Liquidity: <span id="valLiq">â€”</span></div>
      <div class="pill">Volatility: <span id="valVol">â€”</span></div>
      <div class="pill">Violations: <span id="valViol">â€”</span></div>
    </div>

    <div id="divergenceBanner"></div>
    <div id="streetDivergence" class="street">ðŸ”´ STREET: â€”</div>

    <div id="leanSignal">LEAN SIGNAL: â€”<small id="leanSuggestion">â€”</small></div>
    <div id="streetLean" class="street">ðŸ”´ STREET: â€”</div>

    <div id="violations">DISCIPLINE: <span id="violationsText">â€”</span></div>
    <div id="streetDiscipline" class="street">ðŸ”´ STREET: â€”</div>

    <div id="checklist">TODAY: <span id="checklistText" style="color:var(--muted);">â€”</span></div>
    <div id="streetToday" class="street">ðŸ”´ STREET: â€”</div>
  </div>

  <div class="card">
    <h2>Data Source</h2>
    <input id="holdingsUrl" placeholder="HOLDINGS CSV URL">
    <input id="systemUrl" placeholder="SYSTEM_EXPORT CSV URL">
    <textarea id="notesBox" placeholder="Notes"></textarea>
    <button id="saveBtn">Save</button>
  </div>

  <div class="card">
    <h2>Holdings</h2>
    <button id="refreshBtn">Refresh</button>
    <div style="margin-top:8px">Total: <b id="totalValue">$â€”</b></div>
    <table>
      <thead>
        <tr>
          <th>Ticker</th>
          <th>Role</th>
          <th>Bucket</th>
          <th class="right">Shares</th>
          <th class="right">Price</th>
          <th class="right">Value</th>
        </tr>
      </thead>
      <tbody id="holdingsBody">
        <tr><td colspan="6">Waiting for dataâ€¦</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>
const LS_HOLDINGS="lean_holdings_csv_url";
const LS_SYSTEM="lean_system_csv_url";

// Elements (IMPORTANT: statusLine is defined â€” fixes the white page bug)
const statusLine = document.getElementById("statusLine");
const lastUpdated = document.getElementById("lastUpdated");
const nextRefresh = document.getElementById("nextRefresh");

const valRegime=document.getElementById("valRegime");
const valDeploy=document.getElementById("valDeploy");
const valCash=document.getElementById("valCash");
const valL5=document.getElementById("valL5");
const valLiq=document.getElementById("valLiq");
const valVol=document.getElementById("valVol");
const valViol=document.getElementById("valViol");

const divergenceBanner=document.getElementById("divergenceBanner");
const violationsText=document.getElementById("violationsText");
const checklistText=document.getElementById("checklistText");
const leanSignal=document.getElementById("leanSignal");

const streetDivergence=document.getElementById("streetDivergence");
const streetLean=document.getElementById("streetLean");
const streetDiscipline=document.getElementById("streetDiscipline");
const streetToday=document.getElementById("streetToday");

const holdingsUrl=document.getElementById("holdingsUrl");
const systemUrl=document.getElementById("systemUrl");
const holdingsBody=document.getElementById("holdingsBody");
const totalValue=document.getElementById("totalValue");

function money(n){
  if(!isFinite(n)) return "$â€”";
  return n.toLocaleString(undefined,{style:"currency",currency:"USD"});
}

function updateTimestamp(){
  lastUpdated.textContent="LAST UPDATED: "+new Date().toLocaleTimeString();
  lastUpdated.style.opacity="0.4";
  setTimeout(()=>{lastUpdated.style.opacity="1"},200);
}

async function fetchText(url){
  const sep=url.includes("?")?"&":"?";
  const res=await fetch(url+sep+"t="+Date.now(), {cache:"no-store"});
  if(!res.ok) throw new Error("Fetch failed: "+res.status);
  return await res.text();
}

// Simple CSV parser: keep exported values comma-free (your current ones are fine)
function parseCSV(text){
  return text.trim().split("\n").map(r=>r.split(","));
}

function pctToNum(p){
  if(!p || !p.includes("%")) return NaN;
  return parseFloat(p.replace("%",""))/100;
}

function setRegimeGlow(){
  const t=(valRegime.textContent||"").toLowerCase();
  document.body.classList.remove("risk-on","defensive","transition");
  if(t.includes("risk on")) document.body.classList.add("risk-on");
  else if(t.includes("defensive")) document.body.classList.add("defensive");
  else document.body.classList.add("transition");
}

function setStreetLines(){
  const regime=(valRegime.textContent||"").toUpperCase();
  const vol=(valVol.textContent||"").toUpperCase();
  const liq=(valLiq.textContent||"").toUpperCase();
  const viol=(valViol.textContent||"").toUpperCase();
  const cashNum=pctToNum(valCash.textContent);

  // Divergence (funny + calm coach)
  if(regime.includes("RISK ON") && isFinite(cashNum) && cashNum>0.50){
    streetDivergence.textContent="ðŸ”´ STREET: Marketâ€™s jogging. Youâ€™re in the parking lotâ€”on purpose. (Debt mode = fine.)";
  } else if(regime.includes("DEFENSIVE")){
    streetDivergence.textContent="ðŸ”´ STREET: Good. Cash is your seatbelt right now.";
  } else {
    streetDivergence.textContent="ðŸ”´ STREET: Neutral stance. No need to force a move.";
  }

  // Lean (funny + calm coach)
  if(regime.includes("RISK ON") && vol.includes("WATCH")){
    streetLean.textContent="ðŸ”´ STREET: You can nibbleâ€¦ but donâ€™t start acting brand-new. Small bites only.";
  } else if(regime.includes("RISK ON") && vol.includes("CALM") && (liq.includes("LIQUID") || liq.includes("ðŸŸ¢"))){
    streetLean.textContent="ðŸ”´ STREET: Green-ish. Keep it boring: tiny adds, no hero stuff.";
  } else if(regime.includes("DEFENSIVE") || vol.includes("HOT") || liq.includes("TIGHT")){
    streetLean.textContent="ðŸ”´ STREET: Not today. Protect cash and patience. Let it prove itself.";
  } else {
    streetLean.textContent="ðŸ”´ STREET: Mixed signals. Sit on your hands unless itâ€™s a tiny test.";
  }

  // Discipline (funny + calm coach)
  if(!viol || viol==="â€”"){
    streetDiscipline.textContent="ðŸ”´ STREET: Rules clean. No dumb moves detected. Keep it that way.";
  } else {
    streetDiscipline.textContent="ðŸ”´ STREET: Your playbook is yelling at you. Fix violations first.";
  }

  // Today (funny + calm coach)
  const t=(checklistText.textContent||"").toUpperCase();
  if(t.includes("FIX VIOLATIONS")){
    streetToday.textContent="ðŸ”´ STREET: Patch the leaks first. Then we talk offense.";
  } else if(t.includes("OPTIONAL DEPLOY") || t.includes("1â€“2%") || t.includes("1-2%")){
    streetToday.textContent="ðŸ”´ STREET: If you add, keep it small and boring (Lean only).";
  } else if(t.includes("0.5") || t.includes("TEST")){
    streetToday.textContent="ðŸ”´ STREET: Tiny test adds only. No chasing.";
  } else if(t.includes("DEFENSIVE") || t.includes("NO NEW RISK")){
    streetToday.textContent="ðŸ”´ STREET: Chill. Cash > chaos right now.";
  } else {
    streetToday.textContent="ðŸ”´ STREET: Follow the checklist. Donâ€™t freelance.";
  }
}

function setDisciplineText(viol){
  if(!viol || viol.trim()==="" || viol.trim()==="â€”"){
    violationsText.textContent="âœ… No violations";
    violationsText.style.color="var(--green)";
  } else {
    violationsText.textContent=viol.trim();
    const low=viol.toLowerCase();
    if(low.includes("ðŸ”´")) violationsText.style.color="var(--red)";
    else if(low.includes("ðŸŸ¡")) violationsText.style.color="var(--yellow)";
    else violationsText.style.color="var(--yellow)";
  }
}

function computeLeanSignal(){
  const regime=(valRegime.textContent||"").toUpperCase();
  const vol=(valVol.textContent||"").toUpperCase();
  const liq=(valLiq.textContent||"").toUpperCase();
  const deploy=(valDeploy.textContent||"").toUpperCase();

  const cashNum=pctToNum(valCash.textContent);
  const l5Num=pctToNum(valL5.textContent);

  let signal="ðŸŸ¡ CAUTION";
  let reason="Mixed signals.";
  let suggestion="No action implied.";

  const riskOn = regime.includes("RISK ON");
  const defensive = regime.includes("DEFENSIVE");
  const volHot = vol.includes("HOT") || vol.includes("ðŸ”´");
  const volCalm = vol.includes("CALM") || vol.includes("ðŸŸ¢");
  const liqGreen = liq.includes("LIQUID") || liq.includes("ðŸŸ¢");
  const liqRed = liq.includes("TIGHT") || liq.includes("ðŸ”´");

  if (defensive || volHot || liqRed) {
    signal="ðŸ”´ NO-GO";
    reason = defensive ? "Market regime defensive." : (volHot ? "Volatility is hot." : "Liquidity is tight.");
    suggestion="Hold posture. If adding risk, keep it minimal and rule-based.";
  } else if (riskOn && volCalm && liqGreen) {
    signal="ðŸŸ¢ GO";
    reason="Risk-on regime + calm vol + liquid posture.";
    if (isFinite(cashNum) && cashNum > 0.50) suggestion="Consider deploying 1â€“2% into Lean core (not Level 5).";
    else suggestion="Maintain Lean structure. Small adds only if aligned.";
  } else {
    signal="ðŸŸ¡ CAUTION";
    reason="Transition or partial confirmation.";
    if (deploy.includes("CONSIDER") && isFinite(cashNum) && cashNum > 0.50) suggestion="If you deploy, keep it tiny: 0.5â€“1% test adds (Lean only).";
    else suggestion="Stay patient. Wait for confirmation before increasing exposure.";
  }

  if (isFinite(l5Num) && l5Num > 0.05) suggestion += " Level 5 is highâ€”reduce toward â‰¤5%.";

  leanSignal.innerHTML = "LEAN SIGNAL: " + signal + "<small id='leanSuggestion'></small>";
  document.getElementById("leanSuggestion").textContent = reason + " " + suggestion;
}

async function loadSystem(){
  if(!systemUrl.value) return;

  const rows=parseCSV(await fetchText(systemUrl.value));
  const map=new Map();
  rows.forEach(r=>map.set((r[0]||"").toUpperCase(),(r[1]||"").trim()));

  valRegime.textContent=map.get("MARKET REGIME")||"â€”";
  valDeploy.textContent=map.get("DEPLOYMENT SIGNAL")||"â€”";
  valCash.textContent=map.get("CASH ANCHOR %")||"â€”";
  valL5.textContent=map.get("LEVEL5 TOTAL %")||"â€”";
  valLiq.textContent=map.get("LIQUIDITY")||"â€”";
  valVol.textContent=map.get("VOLATILITY")||"â€”";

  const viol = map.get("RULE VIOLATIONS") || map.get("VIOLATIONS") || "â€”";
  valViol.textContent = viol || "â€”";
  setDisciplineText(viol);

  const checklist = map.get("TODAY'S CHECKLIST") || map.get("TODAYS CHECKLIST") || "â€”";
  checklistText.textContent = checklist;

  // Divergence technical
  divergenceBanner.textContent="";
  const regimeLower=(valRegime.textContent||"").toLowerCase();
  if(regimeLower.includes("risk on") && valCash.textContent.includes("%")){
    const cash=pctToNum(valCash.textContent);
    if(isFinite(cash) && cash>0.5) divergenceBanner.textContent="âš  Posture Divergence: Heavy cash in Risk-On regime.";
  }

  setRegimeGlow();
  computeLeanSignal();
  setStreetLines();
  updateTimestamp();
}

async function loadHoldings(){
  if(!holdingsUrl.value) return;

  const rows=parseCSV(await fetchText(holdingsUrl.value));
  const headers=rows[0];
  const idx=(h)=>headers.indexOf(h);
  let total=0;
  const body=[];

  for(let i=1;i<rows.length;i++){
    const r=rows[i];
    if(!r[idx("Ticker")]) continue;
    const value=parseFloat(r[idx("Value")])||0;
    total+=value;
    body.push(`<tr>
      <td>${r[idx("Ticker")]}</td>
      <td>${r[idx("Role")]||""}</td>
      <td>${r[idx("Bucket")]||""}</td>
      <td class="right">${r[idx("Shares")]||""}</td>
      <td class="right">${r[idx("Price")]||""}</td>
      <td class="right">${money(value)}</td>
    </tr>`);
  }

  holdingsBody.innerHTML=body.join("") || `<tr><td colspan="6">No rows.</td></tr>`;
  totalValue.textContent=money(total);
  updateTimestamp();
}

// Buttons
document.getElementById("saveBtn").onclick=()=>{
  localStorage.setItem(LS_HOLDINGS,holdingsUrl.value);
  localStorage.setItem(LS_SYSTEM,systemUrl.value);
  loadSystem();loadHoldings();
};
document.getElementById("refreshBtn").onclick=()=>{loadSystem();loadHoldings()};
document.getElementById("runScanBtn").onclick=()=>{loadSystem();loadHoldings()};

// Load saved URLs
holdingsUrl.value=localStorage.getItem(LS_HOLDINGS)||"";
systemUrl.value=localStorage.getItem(LS_SYSTEM)||"";

// Auto refresh / countdown
let secondsLeft=60;
setInterval(()=>{
  secondsLeft--;
  if(secondsLeft<=0){
    secondsLeft=60;
    statusLine.textContent="Auto-refreshâ€¦";
    Promise.all([loadSystem(), loadHoldings()])
      .then(()=>{ statusLine.textContent="Auto-refresh complete."; })
      .catch(()=>{ statusLine.textContent="Auto-refresh failed (check CSV links)."; });
  }
  nextRefresh.textContent="Next refresh in: "+secondsLeft+"s";
},1000);

// Initial load
Promise.all([loadSystem(), loadHoldings()])
  .then(()=>{ statusLine.textContent="Loaded."; })
  .catch(()=>{ statusLine.textContent="Paste CSV links and click Save."; });

</script>

</body>
</html>
